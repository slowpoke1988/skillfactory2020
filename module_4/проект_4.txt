Задание 4.1
SELECT DISTINCT a.city
FROM dst_project.airports a
WHERE a.city IN (
  SELECT aa.city
  FROM dst_project.airports aa
GROUP BY aa.city
HAVING COUNT(*) > 1


Задание 4.2
Вопрос 1.
SELECT count(DISTINCT status)
FROM dst_project.flights

Вопрос 2.
SELECT count(status)
FROM dst_project.flights
WHERE status = 'Departed'

Вопрос 3.
SELECT count(s.seat_no)
FROM dst_project.aircrafts a
JOIN dst_project.seats s ON a.aircraft_code = s.aircraft_code
WHERE a.model = 'Boeing 777-300'

Вопрос 4.
SELECT count(status)
FROM dst_project.flights
WHERE status = 'Arrived'
  AND actual_arrival BETWEEN '2017-04-01 00:00:00' AND '2017-09-01 00:00:00'



Задание 4.3
Вопрос 1.
SELECT count(status)
FROM dst_project.flights
WHERE status = 'Cancelled'


Вопрос 2.
SELECT aa.model,
       count(aa.model)
FROM
  (SELECT split_part(model, ' ', 1) AS model
   FROM dst_project.aircrafts) aa
GROUP BY 1


Вопрос 3.
SELECT aa.world_part,
       count(aa.world_part)
FROM
  (SELECT split_part(timezone, '/', 1) AS world_part
   FROM dst_project.airports) aa
GROUP BY 1
ORDER BY 1


Вопрос 4.
SELECT flight_id,
       (actual_departure - scheduled_departure) ff
FROM dst_project.flights
WHERE actual_departure NOTNULL
ORDER BY 2 DESC
LIMIT 1


Задание 4.4

Вопрос 1.
SELECT min(f.scheduled_departure)
FROM dst_project.flights f

Вопрос 2.

SELECT max(extract(epoch
                   FROM (f.scheduled_arrival::TIMESTAMP - f.scheduled_departure::TIMESTAMP))/60)
FROM dst_project.flights f


Вопрос 3.
SELECT f.departure_airport,
       f.arrival_airport,
       f.scheduled_arrival-f.scheduled_departure
FROM dst_project.flights f
ORDER BY 3 DESC
LIMIT 1

Вопрос 4.
SELECT avg(extract(epoch
                   FROM (f.scheduled_arrival::TIMESTAMP - f.scheduled_departure::TIMESTAMP))/60)
FROM dst_project.flights f

Задание 4.5


Вопрос 1.
SELECT s.fare_conditions,
       count(s.aircraft_code)
FROM dst_project.seats s
WHERE s.aircraft_code = 'SU9'
GROUP BY s.fare_conditions

Вопрос 2.
SELECT b.total_amount
FROM dst_project.bookings b
ORDER BY 1
LIMIT 1

Вопрос 3.

SELECT b.seat_no
FROM dst_project.tickets t
JOIN dst_project.boarding_passes b ON t.ticket_no=b.ticket_no
WHERE passenger_id = '4313 788533'


Задание 5.1

Вопрос 1.
SELECT count(a.airport_code)
FROM dst_project.airports a
JOIN dst_project.flights f ON a.airport_code = f.arrival_airport
WHERE a.city = 'Anapa'
  AND f.actual_arrival BETWEEN '2017-01-01 00:00:00' AND '2017-12-31 23:59:59

Вопрос 2.
SELECT count(f.flight_id)
FROM dst_project.airports a
JOIN dst_project.flights f ON a.airport_code = f.departure_airport
WHERE a.city = 'Anapa'
  AND (f.actual_departure BETWEEN '2017-12-01 00:00:00' AND '2017-12-31 23:59:59'
       OR f.actual_departure BETWEEN '2017-01-01 00:00:00' AND '2017-02-28 23:59:59')

Вопрос 3.
SELECT count(f.status)
FROM dst_project.airports a
JOIN dst_project.flights f ON a.airport_code = f.departure_airport
WHERE a.city = 'Anapa'
  AND f.status = 'Cancelled'

Вопрос 4.
SELECT DISTINCT count(flights.flight_id)
FROM dst_project.flights
JOIN dst_project.airports ON flights.arrival_airport = airports.airport_code
WHERE flights.departure_airport = 'AAQ'
  AND airports.city != 'Moscow'
Вопрос 5.


SELECT t.aircraft_code,
       count(s.seat_no)
FROM
  (SELECT DISTINCT fl.aircraft_code -- distinct aircr.model
FROM dst_project.FLIGHTS fl
   JOIN dst_project.AIRPORTS ai ON fl.departure_airport = ai.airport_code
   JOIN dst_project.AIRCRAFTS aircr ON fl.aircraft_code = aircr.aircraft_code
   WHERE ai.city = 'Anapa') t
JOIN dst_project.SEATS s ON t.aircraft_code = s.aircraft_code
GROUP BY 1

ДАТАСЕТ

SELECT

f.flight_id,
f.flight_no,
f.scheduled_departure,
f.scheduled_arrival,
f.arrival_airport,
f.aircraft_code,
f.actual_departure,
f.actual_arrival,
tf.fare_conditions,
tf.amount,
s.seats_count
from
(SELECT *
FROM dst_project.flights 
WHERE departure_airport = 'AAQ'
  AND (date_trunc('month', scheduled_departure) in ('2017-01-01','2017-02-01', '2017-12-01'))
  AND status not in ('Cancelled')) f
  join dst_project.ticket_flights tf on f.flight_id = tf.flight_id
-- order by 3

join (SELECT t.aircraft_code,
       count(s.seat_no) seats_count
FROM
  (SELECT DISTINCT fl.aircraft_code -- distinct aircr.model
FROM dst_project.FLIGHTS fl
   JOIN dst_project.AIRPORTS ai ON fl.departure_airport = ai.airport_code
   JOIN dst_project.AIRCRAFTS aircr ON fl.aircraft_code = aircr.aircraft_code
   WHERE ai.city = 'Anapa') t
JOIN dst_project.SEATS s ON t.aircraft_code = s.aircraft_code
GROUP BY 1) s on f.aircraft_code = s.aircraft_code
order by 3


